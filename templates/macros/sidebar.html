{% import "macros/footer.html" as macros_footer %}
{% macro sidebar(config, lang, current_path, section=false, page=false) %}
{# Sidebar configuration with backward compatibility #}
{# Priority: sidebar.* (new) > sidebar_expand_depth (legacy) #}
{% if config.extra.sidebar is defined %}
    {% set sidebar_expand_depth = config.extra.sidebar.expand_depth | default(value=config.extra.sidebar_expand_depth | default(value=0)) | int %}
{% else %}
    {% if config.extra.sidebar_expand_depth is defined %}{% set sidebar_expand_depth = config.extra.sidebar_expand_depth | int %}{% else %}{% set sidebar_expand_depth = 0 %}{% endif %}
{% endif %}
{# Normalize current_path for comparison by removing language prefix #}
{% if lang != config.default_language and current_path is starting_with("/" ~ lang ~ "/") %}
    {% set normalized_current_path = current_path | replace(from="/" ~ lang, to="", count=1) %}
{% else %}
    {% set normalized_current_path = current_path %}
{% endif %}

{# Determine the root section for the sidebar #}
{% set root_section = false %}
{% if section %}
    {# If we are in a section, find the top-level parent #}
    {% if section.components | length > 0 %}
        {% set root_path = section.components | first %}
        {% set root_section = get_section(path=root_path ~ "/_index.md") %}
    {% else %}
        {# We are at root, but we shouldn't be showing sidebar here usually #}
        {% set root_section = section %}
    {% endif %}
{% elif page %}
    {# If we are in a page, find the top-level parent #}
    {% if page.components | length > 0 %}
        {% set root_path = page.components | first %}
        {% set root_section = get_section(path=root_path ~ "/_index.md") %}
    {% endif %}
{% endif %}

{# Fallback to global index if something goes wrong (shouldn't happen with new logic) #}
{% if not root_section %}
    {% set root_section = get_section(path="_index.md") %}
{% endif %}

<label for="my-drawer-2" class="drawer-overlay"></label>
<div class="mt-16 w-68 h-[calc(100vh-4rem)] bg-base-100 text-base-content flex flex-col overflow-auto thin-scrollbar">
    {% if config.build_search_index %}
    <div class="px-2 pt-4 pb-0 flex flex-col items-center gap-2">
        <div class="w-full flex items-center gap-2">
            <label for="search-modal" class="input w-full flex items-center justify-between text-left bg-base-100 cursor-pointer border-gray-500/15 hover:border-gray-500/55 hover:border-1 transition" aria-label="검색">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span class="text-gray-400"><kbd class="kbd">⌘</kbd><kbd class="kbd">K</kbd></span>
            </label>
        </div>
    </div>
    {% endif %}
    
    {# Mobile-only quick navigation - shows main nav items #}
    <div class="lg:hidden px-4 py-2 border-b border-gray-500/10">
        <div class="text-xs font-semibold text-gray-400 mb-2">QUICK NAV</div>
        <ul class="menu menu-compact">
            {% if config.extra.nav is defined %}
                {% for item in config.extra.nav %}
                    {% if item.type == "url" %}
                        <li><a href="{{ get_url(path=item.url) | safe }}" class="text-sm">
                            {% if item.icon %}<i class="{{ item.icon }} mr-2"></i>{% endif %}
                            {{ item.name }}
                        </a></li>
                    {% elif item.type == "dropdown" and item.members %}
                        {% for member in item.members %}
                            <li><a href="{{ get_url(path=member.url) | safe }}" class="text-sm">
                                {% if member.icon %}<i class="{{ member.icon }} mr-2"></i>{% endif %}
                                {{ member.name }}
                            </a></li>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </ul>
    </div>
    
    {# Check if section has content #}
    {% set has_content = root_section.pages | length > 0 or root_section.subsections | length > 0 %}
    
    {# Sidebar Header - Link back to section root #}
    <div class="hidden lg:block px-4 py-2 font-bold text-lg border-b border-gray-500/10 mb-2">
        <a href="{{ root_section.permalink }}" class="hover:text-primary transition-colors">{{ root_section.title }}</a>
    </div>

    {% if not has_content %}
    {# Fallback: Show all top-level sections when current section is empty #}
    <ul class="hidden lg:block menu w-full flex-grow">
        <li class="menu-title">
            <span class="text-xs text-gray-400">ALL SECTIONS</span>
        </li>
        {% set site_root = get_section(path="_index.md") %}
        {% for section_path in site_root.subsections %}
            {% set s = get_section(path=section_path) %}
            {% if not s.transparent %}
                <li><a href="{{ get_url(path=s.path, lang=lang) | safe }}" class="hover:no-underline">
                    {{ s.title }}
                </a></li>
            {% endif %}
        {% endfor %}
    </ul>
    {% else %}
    {# Regular sidebar content #}
    <ul class="hidden lg:block menu w-full flex-grow">
        {# Level 1 - Pages in Root Section #}
        {% for p in root_section.pages %}
            <li {% if normalized_current_path == p.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=p.path, lang=lang) | safe }}">{{ p.title }}</a></li>
        {% endfor %}
        
        {# Level 1 - Subsections #}
        {% for s1_path in root_section.subsections %}
            {% set s1 = get_section(path=s1_path) %}
            {# Skip transparent sections (e.g., blog year folders) #}
            {% if s1.transparent %}{% continue %}{% endif %}
            {% set is_active1 = normalized_current_path is starting_with(s1.path) %}
            <li>
                {% if s1.subsections or s1.pages %}
                    <details {% if is_active1 or sidebar_expand_depth >= 1 %}open{% endif %}>
                        <summary {% if normalized_current_path == s1.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=s1.path, lang=lang) | safe }}">{{ s1.title }}</a></summary>
                        <ul>
                            {# Level 2 #}
                            {% for p in s1.pages %}
                                <li {% if normalized_current_path == p.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=p.path, lang=lang) | safe }}">{{ p.title }}</a></li>
                            {% endfor %}
                            {% for s2_path in s1.subsections %}
                                {% set s2 = get_section(path=s2_path) %}
                                {# Skip transparent sections #}
                                {% if s2.transparent %}{% continue %}{% endif %}
                                {% set is_active2 = normalized_current_path is starting_with(s2.path) %}
                                <li>
                                    {% if s2.subsections or s2.pages %}
                                        <details {% if is_active2 or sidebar_expand_depth >= 2 %}open{% endif %}>
                                            <summary {% if normalized_current_path == s2.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=s2.path, lang=lang) | safe }}">{{ s2.title }}</a></summary>
                                            <ul>
                                                {# Level 3 #}
                                                {% for p in s2.pages %}
                                                    <li {% if normalized_current_path == p.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=p.path, lang=lang) | safe }}">{{ p.title }}</a></li>
                                                {% endfor %}
                                                {% for s3_path in s2.subsections %}
                                                    {% set s3 = get_section(path=s3_path) %}
                                                    {# Skip transparent sections #}
                                                    {% if s3.transparent %}{% continue %}{% endif %}
                                                    {% set is_active3 = normalized_current_path is starting_with(s3.path) %}
                                                    <li>
                                                        {% if s3.subsections or s3.pages %}
                                                            <details {% if is_active3 or sidebar_expand_depth >= 3 %}open{% endif %}>
                                                                <summary {% if normalized_current_path == s3.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=s3.path, lang=lang) | safe }}">{{ s3.title }}</a></summary>
                                                                <ul>
                                                                    {# Level 4 #}
                                                                    {% for p in s3.pages %}
                                                                        <li {% if normalized_current_path == p.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=p.path, lang=lang) | safe }}">{{ p.title }}</a></li>
                                                                    {% endfor %}
                                                                    {% for s4_path in s3.subsections %}
                                                                        {% set s4 = get_section(path=s4_path) %}
                                                                        {# Skip transparent sections #}
                                                                        {% if s4.transparent %}{% continue %}{% endif %}
                                                                        {% set is_active4 = normalized_current_path is starting_with(s4.path) %}
                                                                        <li>
                                                                            {% if s4.subsections or s4.pages %}
                                                                                <details {% if is_active4 or sidebar_expand_depth >= 4 %}open{% endif %}>
                                                                                    <summary {% if normalized_current_path == s4.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=s4.path, lang=lang) | safe }}">{{ s4.title }}</a></summary>
                                                                                    <ul>
                                                                                        {# Level 5 #}
                                                                                        {% for p in s4.pages %}
                                                                                            <li {% if normalized_current_path == p.path %}class="rounded bg-gray-500/15"{% endif %}><a class="hover:no-underline" href="{{ get_url(path=p.path, lang=lang) | safe }}">{{ p.title }}</a></li>
                                                                                        {% endfor %}
                                                                                        {% for s5_path in s4.subsections %}
                                                                                            {% set s5 = get_section(path=s5_path) %}
                                                                                            <li><a {% if normalized_current_path == s5.path %}class="rounded bg-gray-500/15"{% endif %} href="{{ get_url(path=s5.path, lang=lang) | safe }}">{{ s5.title }}</a></li>
                                                                                        {% endfor %}
                                                                                    </ul>
                                                                                </details>
                                                                            {% else %}<a {% if normalized_current_path == s4.path %}class="rounded bg-gray-500/15"{% endif %} href="{{ get_url(path=s4.path, lang=lang) | safe }}">{{ s4.title }}</a>{% endif %}
                                                                        </li>
                                                                    {% endfor %}
                                                                </ul>
                                                            </details>
                                                        {% else %}<a {% if normalized_current_path == s3.path %}class="rounded bg-gray-500/15"{% endif %} href="{{ get_url(path=s3.path, lang=lang) | safe }}">{{ s3.title }}</a>{% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </details>
                                    {% else %}<a {% if normalized_current_path == s2.path %}class="rounded bg-gray-500/15"{% endif %} href="{{ get_url(path=s2.path, lang=lang) | safe }}">{{ s2.title }}</a>{% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </details>
                {% else %}<a {% if normalized_current_path == s1.path %}class="rounded bg-gray-500/15"{% endif %} href="{{ get_url(path=s1.path, lang=lang) | safe }}">{{ s1.title }}</a>{% endif %}
            </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endmacro sidebar %}
